# plasmidseq.config
# Default pipeline configuration (safe to commit).
#
# Override precedence (recommended):
#   1) values exported in your shell environment
#   2) values set in a config passed with -c
#   3) these defaults

# Determine where this config lives (portable relative defaults).
# shellcheck disable=SC2155
CONFIG_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

############################
# Environment
############################

# user group in for shared environment. leave empty if not needed
RESULTS_GROUP="llusers"

# Conda environment name OR full path to a conda env directory.
# Examples:
#   CONDA_ENV="plasmidseq"   (if your conda init is already active)
#   CONDA_ENV="/group/llshared/shared_conda_envs/plasmidseq"
: "${CONDA_ENV:=/group/llshared/shared_conda_envs/plasmidseq}"
: "${CONDA_ENV_PLANNOTATE:=/group/llshared/shared_conda_envs/plannotate}"  # pLannotate environment (full path); set empty to disable

# Optional: path to conda.sh (only needed if conda isn't already initialized in non-interactive jobs)
: "${CONDA_INIT:=}"

# Optional: space-separated module list to load (leave empty to skip module load entirely)
: "${MODULES:=}"

############################
# Locations
############################

# Base output folder (a run subfolder is created under this)
: "${RESULTS_BASE:=/group/llshared/PlasmidSeq/Results}"

# Default mapping TSV and reference fasta folder
: "${DEFAULT_TSV:=/group/llshared/PlasmidSeq/PL_to_fasta.tsv}"
: "${DEFAULT_REFS:=/group/llshared/PlasmidSeq/Fasta_Reference_Files}"

# Scratch root. If your site provides $MYSCRATCH, leaving SCRATCH_BASE unset will use it.
: "${SCRATCH_BASE:=${MYSCRATCH:-}}"

############################
# Pipeline scripts
############################

# Where to find pipeline scripts (default: directory containing this config)
: "${PIPELINE_SCRIPTS_DIR:=$CONFIG_DIR}"

# Basenames (used when resolving scripts inside PIPELINE_SCRIPTS_DIR)
: "${MATCHER_BASENAME:=match_plasmid_fasta_refs_v2.bash}"
: "${MAPPER_BASENAME:=plasmidseq_mapper_PE.sh}"
: "${PREP_SLURM_BASENAME:=plasmidseq_prepare_SLURM.sh}"
: "${MAP_SLURM_BASENAME:=plasmidseq_map_array_SLURM.sh}"
: "${GATHER_SLURM_BASENAME:=plasmidseq_gather_SLURM.sh}"

# Optional absolute overrides (take precedence over basenames/PIPELINE_SCRIPTS_DIR)
: "${MATCHER_PATH:=}"
: "${MAPPER_PATH:=}"
: "${MATCHER_FALLBACK:=}"
: "${MAPPER_FALLBACK:=}"

############################
# Scheduling knobs
############################

# Max parallel mapping tasks requested by submit.sh (array concurrency cap)
: "${MAX_CONCURRENT_DEFAULT:=50}"

# Cluster array size limit (scontrol show config | grep MaxArraySize)
: "${MAX_ARRAY_SIZE:=1001}"

# Slurm partitions (centralized defaults)
: "${PARTITION_PREP:=ll}"
: "${PARTITION_MAP:=work}"
: "${PARTITION_GATHER:=ll}"

# Optional: Slurm account / QoS
: "${SBATCH_ACCOUNT:=}"
: "${SBATCH_QOS:=}"

############################
# Compute resources (mapping jobs)
############################

: "${MAP_CPUS_PER_TASK:=4}"
: "${MAP_MEM_PER_CPU:=6G}"

############################
# Optional variant calling (VarScan)
############################

# Enable per-sample variant calling in mapper (0=off, 1=on)
: "${ENABLE_VARIANTS:=0}"

# VarScan executable (if available in PATH, "varscan" is typical)
: "${VARSCAN_BIN:=varscan}"

# Optional direct path to VarScan jar (takes precedence over VARSCAN_BIN)
: "${VARSCAN_JAR:=}"

# VarScan mpileup2snp/mpileup2indel thresholds
: "${VARSCAN_MIN_COVERAGE:=10}"
: "${VARSCAN_MIN_VAR_FREQ:=0.01}"
: "${VARSCAN_PVALUE:=0.05}"

############################
# Sanity checks (non-fatal)
############################

if [[ -z "${SCRATCH_BASE}" ]]; then
  echo "[config][WARN] SCRATCH_BASE is empty (and MYSCRATCH is unset). Jobs may fail to create scratch dirs." >&2
fi

if [[ -n "${PIPELINE_SCRIPTS_DIR}" && ! -d "${PIPELINE_SCRIPTS_DIR}" ]]; then
  echo "[config][WARN] PIPELINE_SCRIPTS_DIR does not exist: ${PIPELINE_SCRIPTS_DIR}" >&2
fi
